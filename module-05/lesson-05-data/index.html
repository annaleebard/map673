<!DOCTYPE html>
<html>

<head>
	<meta charset=utf-8 />
	<title>A simple map</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src='https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>

	<link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />

	<style>
		body {
			margin: 0;
			padding: 0;
		}
		
		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}
		
		#ui-slider {
			position: absolute;
			top: 20px;
			left: 60px
		}
		
		#grade {
			position: absolute;
			left: 60px;
			top: 50px;
			padding: 6px 15px 8px;
			background: whitesmoke;
			border: 2px solid #d3d3d3
		}
		
		#legend {
			position: absolute;
			right: 0;
			bottom: 30px;
			background: whitesmoke;
			border: 1px solid #d3d3d3
		}
		
		#info {
			position: absolute;
			max-width: 200px;
			display: none;
			background: whitesmoke;
			border: 2px solid #d3d3d3;
			padding: 2px 6px;
		}
		
		#info p {
			margin: 3px 0 4px;
		}
	</style>
</head>

<body>

	<div id='map'></div>
	<div id='ui-slider'>
		<input type="range" min="1" value="1" max="8" step="1" class="slider">
	</div>
	<div id="grade">Grade: <span>1</span>
	</div>
	<div id="legend">
		<h3>2014 Enrollments by County</h3>
		<svg class="legend" width="200" height="200"></svg>
	</div>
	<div id="info">
		<p>County: <span></span>
		</p>
		<p class="girls">girls <span></span>: <span></span>
		</p>
		<p class="boys">boys <span></span>: <span></span>
		</p>
	</div>
	<script>
		L.mapbox.accessToken = 'pk.eyJ1Ijoicmdkb25vaHVlIiwiYSI6Im5Ua3F4UzgifQ.PClcVzU5OUj17kuxqsY_Dg';

		var map = L.mapbox.map('map', 'mapbox.light', {
			center: [-.23, 37.8],
			zoom: 7,
			minZoom: 6,
			maxZoom: 9,
			maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
		});


		var scaleFactor = .6;

		omnivore.csv('kenya_education_2014.csv')
			.on('ready', function (e) {
				drawMap(e.target.toGeoJSON());
				// when this is fired, the layer
				// is done being initialized
			})
			.on('error', function (e) {
				// fired if the layer can't be loaded over AJAX
				// or can't be parsed
			})


		function drawMap(schoolData) {
			var girls = L.geoJson(schoolData, {
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						color: '#D96D02',
						opacity: 1,
						weight: 2,
						fillOpacity: 0,


					});
				}
			}).addTo(map);

			var boys = L.geoJson(schoolData, {
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						color: '#6E77B0',
						fillColor: 'yellow',
						opacity: 1,
						weight: 2,
						fillOpacity: 0,

					});
				}
			}).addTo(map);

			updateSymbols(girls, boys, 1);
			sequenceUI(girls, boys);

		}

		function updateSymbols(girls, boys, currentGrade) {

			var allRadii = [];
			var radius;

			girls.eachLayer(function (layer) {
				radius = calcRadius(layer.feature.properties["G" + currentGrade]);
				layer.setRadius(radius)
				allRadii.push(radius)
			});
			boys.eachLayer(function (layer) {
				radius = calcRadius(layer.feature.properties["B" + currentGrade]);
				layer.setRadius(radius)
				allRadii.push(radius)
			});

			drawLegend(allRadii);
			infoWindow(girls, boys, currentGrade);
		}

		function calcRadius(val) {
			var radius = Math.sqrt(val / Math.PI);
			return radius * .6;
		}

		function sequenceUI(girls, boys) {
			$('.slider')
				.on('input change', function () {
					var currentGrade = $(this).val();
					updateSymbols(girls, boys, currentGrade);
					$('#grade span').html(currentGrade);
				});
		}

		function drawLegend(allRadii) {

			//select legend
			var legend = $('.legend');

			//object finding mean max min
			var circles = {
				max: ss.max(allRadii),
				median: ss.median(allRadii),
				min: ss.min(allRadii)
			}

			var svgCircles = '';

			var reverseCalc = function (radius) {
				return Math.round((Math.pow(radius / scaleFactor, 2) * Math.PI));
			}

			for (var circle in circles) {

				svgCircles += '<circle cx="' + 100 + '" cy="' + (circles[circle] - 180) * -1 + '" r="' + circles[circle] + '" stroke="#d3d3d3" stroke-width="1" fill="ghostwhite" />';

				svgCircles += '<text x="' + 80 + '" y = "' + (circles[circle] - 160) * -1 + '" fill= "green">' + reverseCalc(circles[circle]) + '</text>'
			}

			legend.html(svgCircles)
		}

		function infoWindow(girls, boys, currentGrade) {

			var info = $('#info');

			boys.on('mouseover', function (e) {

				var props = e.layer.feature.properties;

				info.show();
				$('#info p:first-child span').text(props.COUNTY);
				$('.girls span:first-child').text('(grade ' + currentGrade + ')');
				$('.boys span:first-child').text('(grade ' + currentGrade + ')');

				$('.girls span:last-child').text(props['G' + String(currentGrade)].toLocaleString());
				$('.boys span:last-child').text(props['B' + String(currentGrade)].toLocaleString());

				e.layer.setStyle({
					fillOpacity: .4
				});

			});

			boys.on('mouseout', function (e) {
				info.hide();
				e.layer.setStyle({
					fillOpacity: 0
				});
			});


			$(document).mousemove(function (e) {
				info.css({ "left": e.pageX + 6, "top": e.pageY - info.height() -15});
					
					if(info.offset().top  < 4){
					info.css({"top": e.pageY +15})
				}
				if(info.offset().left +info.width() >= $(window).width()-40) {
					info.css({"left": e.pageX - info.width()-30})
				}
			});


		}
	</script>
</body>


</html>